---
slug: low-code-2-backend
title: 开源低代码平台开发实践二：从 0 构建一个基于ER图的低代码后端
author: 悠闲的水
author_title: 自由开发者
author_url: https://github.com/rxdrag
author_image_url: /img/avatar.jpg
tags: [低代码, 前端]
---

前后端分离了！

第一次知道这个事情的时候，内心是困惑的。

前端都出去搞 SPA，SEO 们同意吗？

后来，SSR 来了。

他说：“SEO 们同意了！”

任何人的反对，都没用了，时代变了。

各种各样的 SPA 们都来了，还有穿着跟 SPA 们一样衣服的各种小程序们。

为他们做点什么吧？于是 rxModels 诞生了，作为一个不希望被抛弃的后端，他希望能以更便捷的方式服务前端。

## rxModels 是什么？

一个款开源、通用、低代码后端。

使用 rxModels，只需要绘制 ER 图就可以定制一个开箱即用的后端。提供粒度精确到字段的权限管理功能，并对实例级别的权限管理提供表达式支持。

主要模块有：图形化的实体、关系管理界面( rx-models Client)，通用JSON格式的数据操作接口服务( rx-models )，前端调用辅助 Hooks 库( rxmodels-swr )等。

rxModels 基于 TypeScript，NestJS，TypeORM 和 Antv x6 实现。

TypeScript 的强类型支持，可以把一些错误在编译时就解决掉了，IDE有了强类型的支持，可以自动引入依赖，提高了开发效率，节省了时间。

TypeScript 编译以后的目标执行码时JS，一种运行时解释语言，这个特性赋予了 rxModels 动态发布实体和热加载 `指令` 的能力。用户可以使用 `指令` 实现业务逻辑，扩展通用 JSON 数据接口。给 rxModels 增加了更多使用场景。

NestJS 有助于代码的组织，使其拥有一个良好的架构。

TypeORM 是一款轻量级 ORM 库，可以把对象模型映射到关系数据库。它能够 “分离实体定义”，传入 JSON 描述就可以构建数据库，并对数据库提供面向对象的查询支持。得益于这个特性，图形化的业务模型转换成数据库数据库模型，rxModels 仅需要少量代码就可以完成。

AntV X6 功能相对已经比较全面了，它支持在节点(node)里面嵌入 React组件，利用这个个性，使用它来绘制 ER 图，效果非常不错。如果后面有时间，可以再写一篇文章，介绍如何使用 AntV x6绘制 ER 图。

## rxModels 目标定位

主要为中小项目服务。

为什么不敢服务大项目？

真不敢，作者是业余程序员，没有大项目相关的任何经验。

## 开撸第一步：梳理数据及数据映射

先看一下演示，从直观上知道项目的样子：[rxModels演示](https://rxmodels-client.rxdrag.com/) 。

![界面](/img/blog/blog2-rxmodels-client.jpg)

数据的流转：

1. 制作业务实体模型 -> 实体模型以 JSON 格式保存在数据库 

2. 发布业务实体模型 -> 被发布的实体模型以 JSON文件格式保存在后端目录

3. 服务端启动 -> 从发布目录读取实体模型 -> 转化成 TypeORM能识别的格式 -> TypeORM同步数据库

核心的数据结构有两个：

1. 绘图界面使用的数据，用于保存包、实体、关系、ER 图。这个数据可以被客户端制作并保存，也可以根据这些数据重新把ER图什么的再渲染出来。

2. TypeORM能够接受的实体定义数据

第二部分我们不需要定义，请参考 TypeORM 文档。第一部分是我们关注的重点，这部分数据到底该如何组织？

ER图就是实体关系图，它的核心元素只有两个：实体、关系。

实体包含字段字段，字段有具体类型。关系有三种：1对1，1对多，多对多。

实体、字段、关系，这三方面的信息需要完全映射到数据库，不能多也不能少。这些信息要在后端传递给TypeORM。

还有一些信息，是为了用户便于管理、便于理解的，不影响数据库结构，比如实体在哪个包里，实体在ER图中的位置以及大小，关系在ER图中的位置及形状。这些信息，永远存在于 JSON 里。

### 关系属于谁？

多对多关系在代码中这样表述：

```typescript
export class User{
  ...
  roles: Role[];
  ...
} 

export class Role{
  ...
  users: User[];
  ...
} 
```
这个关系映射到数据库中，会生成中间表加主外键的形式：

```
# user表
user
    id          - integer
...

# role表
user
    id          - integer
...

# user_role表
user
    userId      - integer
    roleId      - integer
...
```

### 图形元数据定义

## GraphQL 是值得进一步深入研究的


## 与前端的第一次接触

rxModels来了，热情的走向前端们。

前端们皱起了眉头，说：“离远点儿，你不是我们理想中的样子。”

rxModels 说：“我还会改变，还会成长，未来的某一天，我们一定是最好的搭档。”

